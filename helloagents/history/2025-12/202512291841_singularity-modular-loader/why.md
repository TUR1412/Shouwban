# 方案说明（Why）：Singularity Modular Loader

目录：`helloagents/plan/202512291841_singularity-modular-loader/`

---

## 1. 背景

本项目定位为「纯静态、无后端依赖」的手办电商多页面模板（PWA Ready）。现有实现将几乎所有运行时逻辑集中在 `scripts/main.js`（约 10k 行），虽然功能完整，但在以下维度存在明显的工程化与性能天花板：

- **首屏解析/编译成本偏高**：任何页面都会下载并解析同一份巨大的脚本，即使页面只需要其中一小部分能力。
- **架构可演进性受限**：跨模块耦合度高，长期维护、回归与增量开发成本上升。
- **缓存粒度偏粗**：任何小改动都会导致整份 `main.js` 缓存失效（或需要统一 bump 版本），影响加载效率。

同时，项目的“高端商业模板”定位要求我们持续增强：

- 视觉一致性与可访问性（A11y）
- 性能与离线体验（PWA）
- 数据可控性与隐私（本地存储的可迁移、可备份）

---

## 2. 目标（Goals）

### 2.1 架构目标

- 将 `scripts/main.js` 内部的初始化流程调整为**按页初始化**（减少无意义的 init 调用），并对关键模块进行结构化梳理，降低维护成本。
- 保持现有“缓存穿透版本号（`?v=YYYYMMDD.N`）”机制可用，确保静态部署在强缓存环境下仍可稳定更新。

### 2.2 产品/体验目标

- 在不引入运行时第三方依赖的前提下，新增一项高价值能力：**本地数据导入/导出**（备份/迁移/恢复），覆盖购物车/收藏/对比/订单/地址簿/积分/降价提醒等关键数据。
- 对 UI 进行微调：补齐数据管理入口与交互提示，保持顶级商业产品的可理解性与一致性。

### 2.3 工程目标

- **极致熵减（工具链）**：移除非必要 devDependencies（优先移除 `terser`，改用 Vite 内置 `esbuild` 压缩）。
- 保持并强化现有自检链路：`npm run verify`、`npm test`、CI validate。

---

## 3. 非目标（Non-goals）

- 不引入真实后端（登录/支付/库存/订单状态等仍为前端演示）。
- 不引入重量级运行时框架（React/Vue/Svelte 等）。
- 不实现“反逆向/自脱壳/无限闭环重写”等不可验证或不可维护机制。

---

## 4. 成功标准（Acceptance Criteria）

- 所有页面正常工作：导航、搜索建议、筛选、详情页、购物车、结算模拟、订单列表、会员中心、PWA、离线页等均可正常使用。
- `npm run verify` 通过（结构校验/版本号一致性/引用完整性）。
- `npm test` 通过（保持 100% 覆盖要求）。
- `App.init()` 改造为按页初始化：页面级模块仅在对应页面执行。
- `package.json` 中移除 `terser`，构建链路仍可用（`npm run build` 在安装依赖后可成功产出 `dist/`）。
- 新增“数据导入/导出/重置”能力：可导出为 JSON 文件、可从 JSON 文件导入并做结构校验/错误提示。

---

## 5. 风险与对策

### 5.1 风险：功能回归（初始化顺序/依赖）

- 对策：
  - 按现有 `App.init()` 顺序分层，先保留“全站基础模块”，再将页面模块按 `Utils.getPageName()` 条件分发。
  - 保持 `npm run verify`/`npm test` 为强约束，避免结构回归。

### 5.2 风险：导入/导出引入隐私误解

- 对策：明确提示“仅本地导入导出，不会上传网络”；导出内容仅包含站点模拟数据；导入必须显式用户操作。

